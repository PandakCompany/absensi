<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-4 sm:p-6 flex flex-col items-center justify-center min-h-screen">

    <div id="login-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h1 class="text-xl sm:text-2xl font-bold mb-6 text-center">üîê Login Absensi Siswa</h1>
        <div class="mb-4">
            <label for="username" class="block text-gray-700 font-semibold mb-2">Username</label>
            <input id="username" type="text" placeholder="Masukkan username" class="border p-2 sm:p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
            <input id="password" type="password" placeholder="Masukkan password" class="border p-2 sm:p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button onclick="handleLogin()" class="bg-blue-600 text-white px-4 py-3 rounded-lg shadow w-full font-semibold hover:bg-blue-700 transition-colors">Masuk</button>
        <p id="login-message" class="text-red-500 text-sm mt-4 text-center hidden">Username atau password salah.</p>
    </div>

    <div id="app-container" class="hidden max-w-7xl w-full mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow-xl">
        <h1 class="text-xl sm:text-2xl font-bold mb-4 text-center">üìö Aplikasi Absensi Siswa</h1>

        <div class="mb-6">
            <h2 id="formTitle" class="text-lg sm:text-xl font-semibold mb-2">Tambah Siswa</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <input id="nis" type="text" placeholder="NIS" class="border p-2 rounded-lg w-full">
                <input id="nama" type="text" placeholder="Nama" class="border p-2 rounded-lg w-full">
                <input id="kelas" type="text" placeholder="Kelas" class="border p-2 rounded-lg w-full">
                <input id="mapel" type="text" placeholder="Mata Pelajaran" class="border p-2 rounded-lg w-full">
            </div>
            <div class="mt-3 flex flex-col sm:flex-row gap-2">
                <button onclick="tambahSiswa()" id="btnTambah" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 w-full sm:w-auto">Tambah</button>
                <button onclick="updateSiswa()" id="btnUpdate" class="hidden bg-yellow-600 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-700 w-full sm:w-auto">Update</button>
                <button onclick="batalEdit()" id="btnBatal" class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 w-full sm:w-auto">Batal</button>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
            <input id="searchInput" type="text" placeholder="üîç Cari nama / NIS / kelas..." onkeyup="tampilkanData()" class="border p-2 rounded-lg w-full sm:w-1/2">
            <button onclick="resetData()" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 w-full sm:w-auto">‚ôª Reset Data</button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200 cursor-pointer text-xs sm:text-base">
                        <th onclick="sortTable('nis')" class="border p-2">NIS ‚¨ç</th>
                        <th onclick="sortTable('nama')" class="border p-2">Nama ‚¨ç</th>
                        <th onclick="sortTable('kelas')" class="border p-2 hidden md:table-cell">Kelas ‚¨ç</th>
                        <th onclick="sortTable('mapel')" class="border p-2 hidden lg:table-cell">Mapel ‚¨ç</th>
                        <th class="border p-2 text-center">Sakit</th>
                        <th class="border p-2 text-center">Izin</th>
                        <th class="border p-2 text-center">Alpa</th>
                        <th class="border p-2 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelSiswa"></tbody>
            </table>
        </div>

        <div class="mt-4 text-center sm:text-right">
            <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">üì• Export Excel</button>
        </div>
    </div>

    <script>
        // --- Skrip JavaScript Anda yang sudah ada di sini ---
        // (handleLogin, initializeApp, tambahSiswa, editSiswa, updateSiswa, batalEdit, hapusSiswa, resetData, updateAbsensi, tampilkanData, sortTable, clearForm, exportExcel)
        // Pastikan semua fungsi ini ada di dalam blok <script> Anda.

        function handleLogin() {
            const usernameInput = document.getElementById("username").value;
            const passwordInput = document.getElementById("password").value;
            const loginMessage = document.getElementById("login-message");

            // Hardcoded username and password. Change these as needed.
            const correctUsername = "saya";
            const correctPassword = "!@#$%";

            if (usernameInput === correctUsername && passwordInput === correctPassword) {
                document.getElementById("login-container").classList.add("hidden");
                document.getElementById("app-container").classList.remove("hidden");
                loginMessage.classList.add("hidden");
                initializeApp(); // Initialize the app after successful login
            } else {
                loginMessage.classList.remove("hidden");
            }
        }

        function initializeApp() {
            let db, sortField = "nis", sortAsc = true, editNIS = null;
            let request = indexedDB.open("AbsensiDB", 2);

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains("siswa")) {
                    let store = db.createObjectStore("siswa", { keyPath: "nis" });
                    store.createIndex("nama", "nama", { unique: false });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                tampilkanData();
            };
        }

        let db, sortField = "nis", sortAsc = true, editNIS = null;
        let request = indexedDB.open("AbsensiDB", 2);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains("siswa")) {
                let store = db.createObjectStore("siswa", { keyPath: "nis" });
                store.createIndex("nama", "nama", { unique: false });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
        };

        // Tambah siswa
        function tambahSiswa() {
            let nis = document.getElementById("nis").value;
            let nama = document.getElementById("nama").value;
            let kelas = document.getElementById("kelas").value;
            let mapel = document.getElementById("mapel").value;
            if (!nis || !nama) {
                alert("NIS dan Nama wajib diisi!");
                return;
            }
            let tx = db.transaction("siswa", "readwrite");
            let store = tx.objectStore("siswa");
            let data = { nis, nama, kelas, mapel, sakit: 0, izin: 0, alpa: 0 };
            store.put(data);
            tx.oncomplete = () => {
                tampilkanData();
                clearForm();
            };
        }

        // Update siswa
        function editSiswa(nis) {
            let tx = db.transaction("siswa", "readonly");
            let store = tx.objectStore("siswa");
            let req = store.get(nis);
            req.onsuccess = function() {
                let siswa = req.result;
                document.getElementById("nis").value = siswa.nis;
                document.getElementById("nis").disabled = true;
                document.getElementById("nama").value = siswa.nama;
                document.getElementById("kelas").value = siswa.kelas;
                document.getElementById("mapel").value = siswa.mapel;
                document.getElementById("btnTambah").classList.add("hidden");
                document.getElementById("btnUpdate").classList.remove("hidden");
                document.getElementById("btnBatal").classList.remove("hidden");
                document.getElementById("formTitle").innerText = "Edit Siswa";
                editNIS = siswa.nis;
            };
        }

        function updateSiswa() {
            let tx = db.transaction("siswa", "readwrite");
            let store = tx.objectStore("siswa");
            let req = store.get(editNIS);
            req.onsuccess = function() {
                let siswa = req.result;
                siswa.nama = document.getElementById("nama").value;
                siswa.kelas = document.getElementById("kelas").value;
                siswa.mapel = document.getElementById("mapel").value;
                store.put(siswa);
                tampilkanData();
                batalEdit();
            };
        }

        function batalEdit() {
            clearForm();
            document.getElementById("btnTambah").classList.remove("hidden");
            document.getElementById("btnUpdate").classList.add("hidden");
            document.getElementById("btnBatal").classList.add("hidden");
            document.getElementById("formTitle").innerText = "Tambah Siswa";
            document.getElementById("nis").disabled = false;
            editNIS = null;
        }

        // Hapus siswa
        function hapusSiswa(nis) {
            if (!confirm("Yakin ingin menghapus siswa ini?")) return;
            let tx = db.transaction("siswa", "readwrite");
            tx.objectStore("siswa").delete(nis);
            tx.oncomplete = tampilkanData;
        }

        // Reset semua data
        function resetData() {
            if (!confirm("Hapus semua data absensi?")) return;
            let tx = db.transaction("siswa", "readwrite");
            let store = tx.objectStore("siswa");
            let clearReq = store.clear();
            clearReq.onsuccess = tampilkanData;
        }

        // Update absensi
        function updateAbsensi(nis, tipe) {
            let tx = db.transaction("siswa", "readwrite");
            let store = tx.objectStore("siswa");
            let request = store.get(nis);
            request.onsuccess = function() {
                let siswa = request.result;
                siswa[tipe]++;
                store.put(siswa);
                tampilkanData();
            };
        }

        // Tampilkan data
        function tampilkanData() {
            let tx = db.transaction("siswa", "readonly");
            let store = tx.objectStore("siswa");
            let request = store.getAll();
            request.onsuccess = function() {
                let siswaList = request.result;
                let keyword = document.getElementById("searchInput").value.toLowerCase();
                if (keyword) {
                    siswaList = siswaList.filter(s =>
                        s.nis.toLowerCase().includes(keyword) ||
                        s.nama.toLowerCase().includes(keyword) ||
                        s.kelas.toLowerCase().includes(keyword)
                    );
                }
                siswaList.sort((a, b) => {
                    let valA = a[sortField].toString().toLowerCase();
                    let valB = b[sortField].toString().toLowerCase();
                    return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
                let tbody = document.getElementById("tabelSiswa");
                tbody.innerHTML = "";
                siswaList.forEach(siswa => {
                    let row = `<tr class="border-b hover:bg-gray-50">
                        <td class="border p-2">${siswa.nis}</td>
                        <td class="border p-2">${siswa.nama}</td>
                        <td class="border p-2 hidden md:table-cell">${siswa.kelas}</td>
                        <td class="border p-2 hidden lg:table-cell">${siswa.mapel}</td>
                        <td class="border p-2 text-center">${siswa.sakit}</td>
                        <td class="border p-2 text-center">${siswa.izin}</td>
                        <td class="border p-2 text-center">${siswa.alpa}</td>
                        <td class="border p-2 text-center flex gap-1 justify-center">
                            <button onclick="updateAbsensi('${siswa.nis}', 'sakit')" class="bg-yellow-500 text-white px-2 py-1 rounded">S</button>
                            <button onclick="updateAbsensi('${siswa.nis}', 'izin')" class="bg-blue-500 text-white px-2 py-1 rounded">I</button>
                            <button onclick="updateAbsensi('${siswa.nis}', 'alpa')" class="bg-red-500 text-white px-2 py-1 rounded">A</button>
                            <button onclick="editSiswa('${siswa.nis}')" class="bg-gray-500 text-white px-2 py-1 rounded">‚úè</button>
                            <button onclick="hapusSiswa('${siswa.nis}')" class="bg-black text-white px-2 py-1 rounded">üóë</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            };
        }

        // Sorting fungsi
        function sortTable(field) {
            sortAsc = (sortField === field) ? !sortAsc : true;
            sortField = field;
            tampilkanData();
        }

        // Clear form
        function clearForm() {
            document.getElementById("nis").value = "";
            document.getElementById("nama").value = "";
            document.getElementById("kelas").value = "";
            document.getElementById("mapel").value = "";
        }

        // Export Excel
        function exportExcel() {
            let tx = db.transaction("siswa", "readonly");
            let store = tx.objectStore("siswa");
            let request = store.getAll();
            request.onsuccess = function() {
                let siswaList = request.result;
                let data = siswaList.map(s => ({
                    NIS: s.nis, Nama: s.nama, Kelas: s.kelas, Mapel: s.mapel,
                    Sakit: s.sakit, Izin: s.izin, Alpa: s.alpa
                }));
                let ws = XLSX.utils.json_to_sheet(data);
                let wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Absensi");
                XLSX.writeFile(wb, "Absensi_Siswa.xlsx");
            };
        }

        // Matikan klik kanan
        document.addEventListener("contextmenu", function(e){
            e.preventDefault();
        });

        // Blokir shortcut tertentu
        document.addEventListener("keydown", function(e) {
            // Ctrl+U (View Source)
            if (e.ctrlKey && e.key.toLowerCase() === "u") {
                e.preventDefault();
            }

            // Ctrl+Shift+I (DevTools)
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "i") {
                e.preventDefault();
            }

            // Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "j") {
                e.preventDefault();
            }

            // Ctrl+S (Save Page)
            if (e.ctrlKey && e.key.toLowerCase() === "s") {
                e.preventDefault();
            }

            // F12 (DevTools)
            if (e.key === "F12") {
                e.preventDefault();
            }

            // Ctrl+C (Copy)
            if (e.ctrlKey && e.key.toLowerCase() === "c") {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
